name: Build, Test and Release

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_NAME: 'edit-sharp'
  PROJECT_PATH: 'edit-sharp/edit-sharp.csproj'

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        trim: [true, false]
        include:
          - os: ubuntu-latest
            runtime: linux-x64
            artifact_base: edit-sharp-linux-x64
          - os: macos-latest
            runtime: osx-x64
            artifact_base: edit-sharp-osx-x64
          - os: windows-latest
            runtime: win-x64
            artifact_base: edit-sharp-win-x64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: Build
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

    - name: Run tests
      run: dotnet test --configuration Release --no-build --verbosity normal

    - name: Generate version number
      id: version
      shell: bash
      run: |
        BUILD_NUMBER=${{ github.run_number }}
        VERSION="1.0.${BUILD_NUMBER}"
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"

    - name: Set artifact name
      id: artifact
      shell: bash
      run: |
        if [ "${{ matrix.trim }}" == "true" ]; then
          SUFFIX="trimmed"
        else
          SUFFIX="full"
        fi
        echo "ARTIFACT_NAME=${{ matrix.artifact_base }}-${SUFFIX}" >> $GITHUB_OUTPUT
        echo "SUFFIX=${SUFFIX}" >> $GITHUB_OUTPUT

    - name: Publish ${{ matrix.runtime }} (Trimmed=${{ matrix.trim }})
      run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --runtime ${{ matrix.runtime }} --self-contained true --output ./publish/${{ steps.artifact.outputs.ARTIFACT_NAME }} /p:Version=${{ steps.version.outputs.VERSION }} /p:PublishSingleFile=true /p:PublishReadyToRun=true /p:PublishTrimmed=${{ matrix.trim }} /p:IncludeNativeLibrariesForSelfExtract=true /p:IncludeAllContentForSelfExtract=true

    - name: Create archive (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        cd ./publish/${{ steps.artifact.outputs.ARTIFACT_NAME }}
        tar -czf ../${{ steps.artifact.outputs.ARTIFACT_NAME }}-v${{ steps.version.outputs.VERSION }}.tar.gz *

    - name: Create archive (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        cd ./publish/${{ steps.artifact.outputs.ARTIFACT_NAME }}
        Compress-Archive -Path * -DestinationPath ../${{ steps.artifact.outputs.ARTIFACT_NAME }}-v${{ steps.version.outputs.VERSION }}.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact.outputs.ARTIFACT_NAME }}-v${{ steps.version.outputs.VERSION }}
        path: |
          ./publish/${{ steps.artifact.outputs.ARTIFACT_NAME }}-v${{ steps.version.outputs.VERSION }}.tar.gz
          ./publish/${{ steps.artifact.outputs.ARTIFACT_NAME }}-v${{ steps.version.outputs.VERSION }}.zip
        retention-days: 7

  create-release:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate version number
      id: version
      run: |
        BUILD_NUMBER=${{ github.run_number }}
        VERSION="1.0.${BUILD_NUMBER}"
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "TAG=v${VERSION}" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Display structure of downloaded files
      run: ls -R ./artifacts

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.TAG }}
        name: Release ${{ steps.version.outputs.TAG }}
        body: |
          ## Edit Sharp ${{ steps.version.outputs.VERSION }}
          
          Automated release built from commit ${{ github.sha }}
          
          ### üì¶ Download Options
          
          #### ü™∂ Trimmed Builds (Lightweight - Recommended for basic editor use)
          **Smaller file size, faster startup, but may cause plugin crashes**
          - **Linux**: `edit-sharp-linux-x64-trimmed-${{ steps.version.outputs.TAG }}.tar.gz`
          - **macOS**: `edit-sharp-osx-x64-trimmed-${{ steps.version.outputs.TAG }}.tar.gz`
          - **Windows**: `edit-sharp-win-x64-trimmed-${{ steps.version.outputs.TAG }}.zip`
          
          #### üîå Full Builds (Plugin Compatible - Recommended for plugin users)
          **Larger file size but better plugin compatibility**
          - **Linux**: `edit-sharp-linux-x64-full-${{ steps.version.outputs.TAG }}.tar.gz`
          - **macOS**: `edit-sharp-osx-x64-full-${{ steps.version.outputs.TAG }}.tar.gz`
          - **Windows**: `edit-sharp-win-x64-full-${{ steps.version.outputs.TAG }}.zip`
          
          ---
          
          ### ‚ö†Ô∏è Which version should I choose?
          
          **Choose Trimmed if:**
          - ‚úÖ You just want a lightweight text editor
          - ‚úÖ You don't plan to use plugins
          - ‚úÖ You want faster startup and smaller download size
          
          **Choose Full if:**
          - ‚úÖ You plan to use or develop plugins
          - ‚úÖ You need maximum compatibility
          - ‚úÖ File size is not a concern
          
          ---
          
          ### üìñ Installation
          
          **Linux/macOS:**
          ```bash
          # Extract (replace with your chosen file)
          tar -xzf edit-sharp-*-${{ steps.version.outputs.TAG }}.tar.gz
          chmod +x edit-sharp
          ./edit-sharp
          ```
          
          **Windows:**
          ```cmd
          # Extract (replace with your chosen file)
          unzip edit-sharp-win-x64-*-${{ steps.version.outputs.TAG }}.zip
          edit-sharp.exe
          ```
        draft: false
        prerelease: false
        files: |
          ./artifacts/**/*.tar.gz
          ./artifacts/**/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
